<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<title>Kafka Cost Control</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body class="article">
<div id="header">
<h1>Kafka Cost Control</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_user_manual">1. User Manual</a>
<ul class="sectlevel2">
<li><a href="#_introduction">1.1. Introduction</a>
<ul class="sectlevel3">
<li><a href="#_graphql">1.1.1. Graphql</a></li>
<li><a href="#_authorization">1.1.2. Authorization</a></li>
</ul>
</li>
<li><a href="#_config_samples">1.2. Config samples</a></li>
<li><a href="#_configuring_your_cost_control_application">1.3. Configuring your cost control application</a>
<ul class="sectlevel3">
<li><a href="#_configuring_aggregation_types">1.3.1. Configuring aggregation types</a></li>
<li><a href="#_configuring_transformations">1.3.2. Configuring transformations</a></li>
</ul>
</li>
<li><a href="#_pricing_rules">1.4. Pricing rules</a>
<ul class="sectlevel3">
<li><a href="#_listing_pricing_rules">1.4.1. Listing pricing rules</a></li>
<li><a href="#_setting_a_pricing_rule">1.4.2. Setting a pricing rule</a></li>
<li><a href="#_removing_a_pricing_rule">1.4.3. Removing a pricing rule</a></li>
</ul>
</li>
<li><a href="#_context_data">1.5. Context data</a>
<ul class="sectlevel3">
<li><a href="#_listing_existing_context_data">1.5.1. Listing existing context data</a></li>
<li><a href="#_setting_context_data">1.5.2. Setting context data</a></li>
<li><a href="#_removing_context_data">1.5.3. Removing context data</a></li>
</ul>
</li>
<li><a href="#_reprocess">1.6. Reprocess</a>
<ul class="sectlevel3">
<li><a href="#_using_the_ui">1.6.1. Using the UI</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#section-installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">2.1. Prerequisites</a></li>
<li><a href="#_topics_and_avro_schemas">2.2. Topics and AVRO schemas</a>
<ul class="sectlevel3">
<li><a href="#_reference_avro_schemas">2.2.1. Reference AVRO schemas</a></li>
<li><a href="#section-topics">2.2.2. Topics</a></li>
</ul>
</li>
<li><a href="#_kubernetes">2.3. Kubernetes</a>
<ul class="sectlevel3">
<li><a href="#_kafka_metric_scraper">2.3.1. Kafka metric scraper</a></li>
<li><a href="#_kafka_cost_control">2.3.2. Kafka cost control</a></li>
<li><a href="#_helm_chart_strimzi_only">2.3.3. Helm Chart (Strimzi only)</a></li>
</ul>
</li>
<li><a href="#_metric_database">2.4. Metric database</a>
<ul class="sectlevel3">
<li><a href="#_duckdb_integration">2.4.1. DuckDB Integration</a></li>
<li><a href="#_timescaledb_database_schema">2.4.2. TimescaleDB Database Schema</a></li>
</ul>
</li>
<li><a href="#_kafka_connect">2.5. Kafka connect</a>
<ul class="sectlevel3">
<li><a href="#_configuration_of_the_connectors">2.5.1. Configuration of the connectors</a></li>
</ul>
</li>
<li><a href="#_grafana">2.6. Grafana</a>
<ul class="sectlevel3">
<li><a href="#_database_connection">2.6.1. Database connection</a></li>
</ul>
</li>
<li><a href="#_troubleshooting">2.7. Troubleshooting</a>
<ul class="sectlevel3">
<li><a href="#_kafka_cost_control_is_never_ready">2.7.1. Kafka cost control is never ready</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_architecture">3. Architecture</a>
<ul class="sectlevel2">
<li><a href="#section-introduction-and-goals">3.1. Introduction and Goals</a>
<ul class="sectlevel3">
<li><a href="#_requirements_overview">3.1.1. Requirements Overview</a></li>
<li><a href="#_quality_goals">3.1.2. Quality Goals</a></li>
<li><a href="#_stakeholders">3.1.3. Stakeholders</a></li>
</ul>
</li>
<li><a href="#section-architecture-constraints">3.2. Architecture Constraints</a></li>
<li><a href="#section-system-scope-and-context">3.3. System Scope and Context</a></li>
<li><a href="#section-solution-strategy">3.4. Solution Strategy</a>
<ul class="sectlevel3">
<li><a href="#_used_technologies">3.4.1. Used Technologies</a></li>
<li><a href="#_time_based_aggregations_scraping_intervals">3.4.2. Time based aggregations &amp; scraping intervals</a></li>
</ul>
</li>
<li><a href="#section-building-block-view">3.5. Building Block View</a>
<ul class="sectlevel3">
<li><a href="#_whitebox_overall_system">3.5.1. Whitebox Overall System</a></li>
<li><a href="#_metricsscraper">3.5.2. MetricsScraper</a></li>
<li><a href="#_pricingrules">3.5.3. PricingRules</a></li>
<li><a href="#_contextprovider">3.5.4. ContextProvider</a></li>
</ul>
</li>
<li><a href="#section-runtime-view">3.6. Runtime View</a>
<ul class="sectlevel3">
<li><a href="#_metrics_ingestion_from_confluent_cloud">3.6.1. Metrics Ingestion from Confluent Cloud</a></li>
<li><a href="#_metrics_using_kafka_admin_api">3.6.2. Metrics using Kafka Admin API</a></li>
<li><a href="#_other_sources_of_metrics">3.6.3. Other sources of metrics</a></li>
<li><a href="#_metrics_enrichment">3.6.4. Metrics Enrichment</a></li>
<li><a href="#_metrics_grouping">3.6.5. Metrics Grouping</a></li>
</ul>
</li>
<li><a href="#section-deployment-view">3.7. Deployment View</a></li>
<li><a href="#section-technical-risks">3.8. Risks and Technical Debts</a></li>
<li><a href="#section-glossary">3.9. Glossary</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_user_manual">1. User Manual</h2>
<div class="sectionbody">
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="_introduction">1.1. Introduction</h3>
<div class="paragraph">
<p>This user manual will help you understand kafka Cost Control and how to use it propertly. This document assumes that you already have a running application. If not please see the <a href="#section-installation">Installation</a> section.</p>
</div>
<div class="paragraph">
<p>At this point you should have access to the Kafka Cost Control UI and to the Grafana Dashboard.</p>
</div>
<div class="sect3">
<h4 id="_graphql">1.1.1. Graphql</h4>
<div class="paragraph">
<p>Kafka cost control provides a graphql endpoint at: <em>&lt;your-host&gt;/graphql-ui</em></p>
</div>
<div class="paragraph">
<p>In addition, there is a ready to use GraphQL UI. You can access it by going to the following URL: <em>&lt;your-host&gt;/graphql-ui</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_authorization">1.1.2. Authorization</h4>
<div class="paragraph">
<p>TODO explain basic auth stuff
TODO explain the localstorage trick</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_config_samples">1.2. Config samples</h3>
<div class="paragraph">
<p>If you want to quickly get started, you can create pricing rules and context data using the <a href="https://github.com/spoud/kafka-cost-control/tree/master/config-sample">config sample folder</a>. All you need is node JS 20+.</p>
</div>
<div class="paragraph">
<p>Be sure to edit the files <code>pricing-rules.json</code> and <code>context-data.json</code> to match your environment.</p>
</div>
<div class="paragraph">
<p>To persist the configuration you can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node index.js --url=https://&lt;your-host&gt;/graphql --user=admin --password=your-password</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have issues you can try to add the <code>--verbose</code> options. This will display all the requests.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_configuring_your_cost_control_application">1.3. Configuring your cost control application</h3>
<div class="paragraph">
<p>Your cost control instance can be configured either by setting environment variables,
or (if you are using one of the provided container images) by mounting an <code>application.properties</code> file at
<code>/deployments/config/application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># inside your application.properties
quarkus.profile=ccloud</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_aggregation_types">1.3.1. Configuring aggregation types</h4>
<div class="paragraph">
<p>In cost control, each metric is associated with an aggregation type. The aggregation type determines how multiple measurements
within a time window are combined to produce a single value. Possible aggregation types are <code>SUM</code> and <code>MAX</code>.
If no aggregation type is specified for a metric, then <code>SUM</code> will be used.
To specify an aggregation type for a metric, add a line to your <code>application.properties</code> file like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"># inside your application.properties
cc.metrics.aggregations.&lt;metric-name&gt;=max</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, to aggregate retained byte measurements using the <code>MAX</code> aggregation type, add the following line to your <code>application.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cc.metrics.aggregations.confluent_kafka_server_retained_bytes=max</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that these settings may only be set in an <code>application.properties</code> file, and not via environment variables.
This is due to the fact that Quarkus cannot unambiguously map environment variable names to property names if said
property names contain user-defined parts (like <code>confluent_kafka_server_retained_bytes</code> in the example above).
For more information, see <a href="https://quarkus.io/guides/config-reference#environment-variables">the relevant section of the Quarkus documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_transformations">1.3.2. Configuring transformations</h4>
<div class="paragraph">
<p>Currently, there is one kind of transformation that can be added to the metrics processing pipeline: <code>splitTopicMetricAmongPrincipals</code>.
This transformation is configured by supplying a map of metric names to context keys in application.properties. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cc.metrics.transformations.splitMetricAmongPrincipals={bytesin:'writers',bytesout:'readers'}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expect <code>bytesin</code> metrics to have a <code>writers</code> key in their context, which should be a comma-separated list of principals (e.g. applications, teams, &#8230;&#8203;)
that can write to this topic. When a <code>bytesin</code> metric for any topic is encountered, the metric will be replaced with <code>n</code> metrics (where <code>n</code> is the length of the <code>writers</code> list
in that metric&#8217;s context). The name of the topic will be moved into that metric&#8217;s context under the <code>topic</code> key and the name of a principal from the <code>writers</code>
list will move into the metric&#8217;s <code>name</code> field. The value of each generated metric will be the value of the original metric divided by <code>n</code>.</p>
</div>
<div class="paragraph">
<p>In effect this takes a single metric that says "90 kb have been written to topic ABC by writers X,Y,Z" and transforms it into 3 metrics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Principal X wrote 30 kb to topic ABC</p>
</li>
<li>
<p>Principal Y wrote 30 kb to topic ABC</p>
</li>
<li>
<p>Principal Z wrote 30 kb to topic ABC</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The advantage over the original metric is that each such transformed metric will be put into its own database row, which will make it easier to aggregate by principal
(e.g. answer questions like "how much did principal X produce in the past month"). This type of transformation is especially relevant when doing cost control based on vanilla
Kafka broker metrics (as is the case in Strimzi deployments, for example), because here only topic-level metrics are generated natively. This transformation allows to turn
these topic-focused metrics into principal-focused ones.</p>
</div>
<div class="paragraph">
<p>Some metrics that are configured this way may not have a matching context key in the context. To handle such cases, cost control offers three different strategies
that can be enabled by setting the <code>cc.metrics.transformations.config.splitMetricAmongPrincipals.missingKeyHandling</code> property in <code>application.properties</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ASSIGN_TO_FALLBACK</code>: The metric will be handled as if the context key existed and contained a single principal name. This fallback principal name is set to "unknown" per default but can be changed
by setting the <code>metrics.transformations.config.splitMetricAmongPrincipals.fallbackPrincipal</code> property in <code>application.properties</code>.</p>
</li>
<li>
<p><code>DROP</code>: The metric will not be forwarded downstream and will be dropped.</p>
</li>
<li>
<p><code>PASS_THROUGH</code>: The metric will be passed downstream without any changes. This is the default behavior.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that <code>cc.metrics.transformations.config.splitMetricAmongPrincipals.missingKeyHandling</code> is expected to be a map of metric names to one of the above strategies.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">cc.metrics.transformations.config.splitMetricAmongPrincipals.missingKeyHandling={bytesin:'ASSIGN_TO_FALLBACK',bytesout:'DROP'}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no strategy is specified for a metric, then <code>ASSIGN_TO_FALLBACK</code> will be used.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_pricing_rules">1.4. Pricing rules</h3>
<div class="paragraph">
<p>Pricing rules are a way to put a price on each metric. The price will be applied on the <strong>hourly</strong> aggregate.  Also, it&#8217;s common for metrics to be in <strong>bytes</strong> and not Megabyte or Gigabyte. Keep that in mind when setting the price.
For example, if you want to have a price of <em>1.0$</em> per <em>GB</em> you will need to set the price to <em>1.0/1024<sup>3</sup></em> = <em>0.000976276$</em> per <em>byte</em>.</p>
</div>
<div class="paragraph">
<p>Pricing rules are stored in kafka in a compacted topic. The key should be the metric name.</p>
</div>
<div class="sect3">
<h4 id="_listing_pricing_rules">1.4.1. Listing pricing rules</h4>
<div class="sect4">
<h5 id="_from_the_ui">From the UI</h5>
<div class="paragraph">
<p>Simply go to the pricing rules tab of the UI. You should see the metric name and it&#8217;s cost.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">query getAllRules {
  pricingRules {
    creationTime
    metricName
    baseCost
    costFactor
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_a_pricing_rule">1.4.2. Setting a pricing rule</h4>
<div class="sect4">
<h5 id="_from_the_ui_2">From the UI</h5>
<div class="paragraph">
<p><em>Not available yet.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql_2">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">mutation saveRule {
  savePricingRule(
    request: {metricName: "whatever", baseCost: 0.12, costFactor: 0.0001}
  ) {
    creationTime
    metricName
    baseCost
    costFactor
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_a_pricing_rule">1.4.3. Removing a pricing rule</h4>
<div class="sect4">
<h5 id="_from_the_ui_3">From the UI</h5>
<div class="paragraph">
<p><em>Not available yet.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql_3">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">mutation deleteRule {
  deletePricingRule(request: {metricName: "whatever"}) {
    creationTime
    metricName
    baseCost
    costFactor
  }
}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_context_data">1.5. Context data</h3>
<div class="paragraph">
<p>Context data are a way to attach a context (attributes basically) to a kafka item (topic, principal, &#8230;&#8203;). Basically define a set of key/values for an item that match a regex. It is possible that one item match multiple regex (and thus multiple context), but in this case you have to be careful to not have conflicting key/values.</p>
</div>
<div class="paragraph">
<p>You can have as much key/values as you want. They will be used to sum up prices in the dashboard. It is therefor important that you have at least one key/value that defined the cost unit or organization unit. For example: <code>organzation_unit=department1</code>.</p>
</div>
<div class="paragraph">
<p>The context data are stored in kafka in a compacted topic. The key is free for the user to choose.</p>
</div>
<div class="sect3">
<h4 id="_listing_existing_context_data">1.5.1. Listing existing context data</h4>
<div class="sect4">
<h5 id="_from_the_ui_4">From the UI</h5>
<div class="paragraph">
<p>Go to the tab <em>Context Data</em> in the UI. You should see all the context with their validity time, type, regex and context key/values.</p>
</div>
<div class="paragraph">
<p>If you are signed in, you can use the context tester via the button <em>test context data</em> to check what context key/values currently apply to your topic or principal.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql_4">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">query getContextData {
  contextData {
    id
    creationTime
    validFrom
    validUntil
    entityType
    regex
    context {
      key
      value
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_context_data">1.5.2. Setting context data</h4>
<div class="paragraph">
<p>If you want to create a new context, you can omit the id if you want. If no id is set, the API will generate one for you using a UUID.
If you use an id that is not yet in the system, this means you&#8217;re creating a new context item.</p>
</div>
<div class="sect4">
<h5 id="_from_the_ui_5">From the UI</h5>
<div class="paragraph">
<p>In the Context Data tab via the button <em>Add context data</em>. You need to be signed in for the button to be visible.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql_5">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">mutation saveContextData {
  saveContextData(
    request: {id: "323b603d-5b5f-48d2-84fc-4e784e942289", entityType: TOPIC, regex: ".*collaboration", context: [{key: "app", value: "agoora"}, {key: "cost-unit", value: "spoud"}, {key: "domain", value: "collaboration"}]}
  ) {
    id
    creationTime
    entityType
    regex
    context {
      key
      value
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_removing_context_data">1.5.3. Removing context data</h4>
<div class="sect4">
<h5 id="_from_the_ui_6">From the UI</h5>
<div class="paragraph">
<p><em>Not available yet.</em></p>
</div>
</div>
<div class="sect4">
<h5 id="_using_graphql_6">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">mutation deleteContextData {
  deleteContextData(request: {id: "323b603d-5b5f-48d2-84fc-4e784e942289"}) {
    id
    creationTime
    entityType
    regex
    context {
      key
      value
    }
  }
}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reprocess">1.6. Reprocess</h3>
<div class="paragraph">
<p>Reprocessing should only be used when you made a mistake, fixed it and want to reprocess the raw data. Reprocessing will induce a lag, meaning data will not be live for a little while. Depending on how much data you want to reprocess this can take minutes or hours. So be sure to know what you are doing. After the reprocessing is done, the data will be live again. Reprocessing will <strong>NOT</strong> lose data. They will just take a bit of time to appear live again.</p>
</div>
<div class="paragraph">
<p>Be aware that in the reprocessing action may take a while to complete (usually about 1 min). This is why you should be patient with the request.</p>
</div>
<div class="paragraph">
<p>The process is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>use request reprocessing</p>
</li>
<li>
<p>KafkaCostControl MetricProcess kafka stream application will stop</p>
</li>
<li>
<p>Wait for all consumers to stop and for kafka to release the consumer group (this may take time)</p>
</li>
<li>
<p>KafkaCostControl will look for the offset of the timestamp requested for the reprocessing (if not timestamp requested, it will just see to zero)</p>
</li>
<li>
<p>KafkaCostControl will self-destruct in order for kubernetes to restart it (you may see a restart count increasing)</p>
</li>
<li>
<p>KafkaCostControl kafka stream application will resume from the offset defined by the timestamp you gave</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The metric database should be independent. This means it should be able to accept updates. Otherwise, you will need to clean the database yourself before a reprocessing.</p>
</div>
<div class="sect3">
<h4 id="_using_the_ui">1.6.1. Using the UI</h4>
<div class="ulist">
<ul>
<li>
<p>Go to the <em>Others</em> tab.</p>
</li>
<li>
<p>Choose a date for the start time of the reprocessing (empty means from the beginning of time). You can help yourself with the quick button on top.</p>
</li>
<li>
<p>Click on reprocess</p>
</li>
<li>
<p>Confirm the reprocessing</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_using_graphql_7">Using Graphql</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-graphql hljs" data-lang="graphql">mutation reprocess {
  reprocess(areYouSure: "no", startTime:"2024-01-01T00:00:00Z")
}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="section-installation">2. Installation</h2>
<div class="sectionbody">
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="_prerequisites">2.1. Prerequisites</h3>
<div class="paragraph">
<p>This installation manual assumes that</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You have a Kafka cluster</p>
</li>
<li>
<p>You have a schema registry</p>
</li>
<li>
<p>You have a Kubernetes cluster</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_topics_and_avro_schemas">2.2. Topics and AVRO schemas</h3>
<div class="paragraph">
<p>Kafka cost control uses internal topic to compute pricing. You will have to create those topic before deploying the application. The documentation will show the default names, you can change them but don&#8217;t forget to adapt the aggregator configuration.</p>
</div>
<div class="sect3">
<h4 id="_reference_avro_schemas">2.2.1. Reference AVRO schemas</h4>
<div class="paragraph">
<p>Some schemas will reference <a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/entity-type-enum.avsc">EntityType</a>. Please add it to your schema registry and reference it when needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="section-topics">2.2.2. Topics</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Topic name</th>
<th class="tableblock halign-left valign-top">Clean up policy</th>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">context-data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">compact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>String</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/context-data.avsc">ContextData</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pricing-rules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">compact</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>String</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/pricing-rule.avsc">PricingRule</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/aggregated-data-key.avsc">AggregatedDataKey</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/aggregated-data-windowed.avsc">AggregatedDataWindowed</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">aggregated-table-friendly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/aggregated-data-key.avsc">AggregatedDataKey</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/spoud/kafka-cost-control/tree/master/aggregator/src/main/avro/aggregated-data-table-friendly.avsc">AggregatedDataTableFriendly</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">metrics-raw-telegraf-dev</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>None</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>String</em></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_context_data_2">Context data</h5>
<div class="paragraph">
<p>This topic will contain the additional information you wish to attach to the metrics. SEE TODO for more information. This topic is compacted and it is important that you take care of the key yourself. If you wish to delete a context-data you can set <em>null</em> as payload (and provide the key you want to delete).</p>
</div>
</div>
<div class="sect4">
<h5 id="_pricing_rule">Pricing rule</h5>
<div class="paragraph">
<p>This topic will contain the price of each metric. Be aware that most of the metric will be in <em>bytes</em>. So if you want for example to have a price of <em>1.0$</em> per <em>GB</em> you will need to set the price to <em>1.0/1024<sup>3</sup></em> = <em>0.000976276$</em> per <em>byte</em>. The key should be the metric name. If you wish to remove a price value, send the payload <em>null</em> with the key you want to delete. See TODO on how to use the API or the UI to set the price.</p>
</div>
</div>
<div class="sect4">
<h5 id="_aggregated">Aggregated</h5>
<div class="paragraph">
<p>This topic will contain the enriched data. This is the result topic of the aggregator.</p>
</div>
</div>
<div class="sect4">
<h5 id="_aggregated_table_friendly">Aggregated table friendly</h5>
<div class="paragraph">
<p>This is the exact same thing as <em>aggregated</em> except there are no hashmap and other nested field. Everything has be flattened. This topic make it easy to use Kafka Connect with a table database.</p>
</div>
</div>
<div class="sect4">
<h5 id="_metrics_raw_telegraf">Metrics raw telegraf</h5>
<div class="paragraph">
<p>You can have multiple raw topics. For example one per environment or one per kafka cluster. The topic name is up to you, just don&#8217;t forget to configure it properly when you deploy telegraf (see Kubernetes section).
Give some special consideration to the <code>retention.ms</code> setting for the raw metrics topics. For example, if you want to distribute the cost of your monthly bill based on the raw metrics scraped over the course of the
month then it is a good idea to retain the scraped data for more than 30 days. This gives people time to ask questions about their bill and also gives the opportunity to reprocess the metrics with new pricing rules/contexts
if needed.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes">2.3. Kubernetes</h3>
<div class="paragraph">
<p>You can find all the deployment files in the <a href="https://github.com/spoud/kafka-cost-control/tree/master/deployment">deployment</a> folder. This folder use <a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/">Kustomize</a> to simplify the deployment of multiple instances with some variations.</p>
</div>
<div class="paragraph">
<p>The kubernetes deployment is in two parts. One part is the <strong>kafka control software</strong> (processing, ui, dashboard, etc.) and the other part is the <strong>kafka metric scrapper</strong>. You may have multiple kafka metric scrapper deployment (one per kafka cluster for example), but you should need only one kafka cost control deployment.</p>
</div>
<div class="sect3">
<h4 id="_kafka_metric_scraper">2.3.1. Kafka metric scraper</h4>
<div class="paragraph">
<p>This part will be responsible to scrape kafka for relevant metrics. Depending on what metrics you want to provide you will need a user with read access to kafka metric but also kafka admin client. Read permission is enough ! You don&#8217;t need a user with write permission.</p>
</div>
<div class="paragraph">
<p>This documentation will assume that you use the <code>dev/</code> folder, but you can configure as much Kustomize folders as you want. The <code>dev/</code> folder is a good starting point if you have confluent cluster running.</p>
</div>
<div class="paragraph">
<p>Copy the environment sample file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd deployment/kafka-metric-scrapper/dev
cp .env.sample .env
vi .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the environment file with the correct output topic, endpoints and credentials.</p>
</div>
<div class="paragraph">
<p>Be sure to edit the <strong>namespace</strong> in the <a href="https://github.com/spoud/kafka-cost-control/tree/master/deployment/kafka-metric-scrapper/dev/kustomization.yaml">kustomization.yaml</a> file.</p>
</div>
<div class="paragraph">
<p>Deploy the dev environment using kubectl</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd /deployment/kafka-metric-scrapper
kubectl apply -k dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the deployment to finish and check the output topic for metrics. You should receive new data every minute.</p>
</div>
</div>
<div class="sect3">
<h4 id="_kafka_cost_control">2.3.2. Kafka cost control</h4>
<div class="paragraph">
<p>For this part we will deploy the kafka stream application that is responsible to enrich the metrics, TimescaleDB for storing the metrics, kafka connect instance to sink the metric into the database, a grafana dashboard and a simple UI to define prices and contexts.</p>
</div>
<div class="paragraph">
<p>This documentation will assume that you use the <code>dev/</code> folder, but you can configure as much Kustomize folders as you want.</p>
</div>
<div class="paragraph">
<p>Copy the environment sample file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd deployment/kafka-cost-control/app
cp .env.sample .env
vi .env</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the environment file with the correct credentials. The database password can be randomly generated. It will be used by kafka connect and grafana.</p>
</div>
<div class="paragraph">
<p>Be sure to edit the <strong>namespace</strong> in the <a href="https://github.com/spoud/kafka-cost-control/tree/master/deployment/kafka-cost-control/app/kustomization.yaml">kustomization.yaml</a> file.</p>
</div>
<div class="paragraph">
<p>You also may want to adapt the ingress files to use a proper hosts. You will need two hosts, one for grafana and one for the kafka cost control application.</p>
</div>
<div class="paragraph">
<p>Deploy the application using kubectl</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd /deployment/kafka-metric-scrapper
kubectl apply -k app</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_helm_chart_strimzi_only">2.3.3. Helm Chart (Strimzi only)</h4>
<div class="paragraph">
<p>If your Kafka cluster is managed by the Strimzi operators, you can use the provided Helm chart (under <code>helm/kcc-strimzi</code>) to deploy
Cost Control with all the required components (Telegraf, Aggregator, UI, TimescaleDB, Kafka Connect) as well as all the required
users and topics. The Helm chart still assumes that you already have a Schema Registry deployed.
See the relevant README file for more information.</p>
</div>
<div class="paragraph">
<p>A component that is special to the Strimzi deployment is the Context Operator.
This operator detects <code>KafkaUser</code> resources with a specific annotation and automatically creates
a corresponding <code>Context</code> in Cost Control. This allows you to manage your contexts directly from Kubernetes.
See the README in <code>strimzi-operator</code> for more information.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_metric_database">2.4. Metric database</h3>
<div class="paragraph">
<p>For storing the metrics, we recommend using either an external time series database or, alternatively, the built-in DuckDB integration.</p>
</div>
<div class="paragraph">
<p>The advantage of the DuckDB integration is that it is easy to set up and does not require any additional downstream components (e.g. Kafka Connect and a time series database).
However, the DuckDB integration is not as scalable as a dedicated external database. It currently also only supports downloading an export of the metrics for some time period.
These exports can be downloaded in JSON and CSV format for offline analysis (e.g. in a Jupyter notebook).
Note that when the DuckDB integration is used, a stream of aggregated metrics is still sent to Kafka, so that it is possible to switch to using an external time series database at any time.</p>
</div>
<div class="paragraph">
<p>The time series database approach is more scalable and allows leveraging the full power of the database for querying and analyzing the metrics.
However, it also requires additional components to be set up, such as Kafka Connect and the database itself.
Feel free to choose the database that suits your needs, but be careful to choose one that is compatible with Kafka connect (or is otherwise capable of receiving data from Kafka) so you can easily transfer metrics from Kafka to your database.
In this example we will assume that you&#8217;re using TimescaleDB because it&#8217;s the one we provide Kubernetes manifest for.</p>
</div>
<div class="paragraph">
<p>In the following sections we will show you how to set up both the DuckDB integration and TimescaleDB.
Feel free to skip the section that does not apply to your use case.</p>
</div>
<div class="sect3">
<h4 id="_duckdb_integration">2.4.1. DuckDB Integration</h4>
<div class="paragraph">
<p>The DuckDB integration is disabled by default. To enable it, set the following environment variables in your Aggregator deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">      containers:
        - name: kafka-cost-control
          image: spoud/kafka-cost-control:latest
          env:
            # enable the DuckDB integration
            - name: CC_OLAP_ENABLED
              value: "true"
            # path in the container where the DuckDB database will be stored
            # if this is not set, the data will be stored in-memory (i.e. it will be lost when the container is restarted)
            - name: CC_OLAP_DATABASE_URL
              value: "jdbc:duckdb:/home/jboss/kafka-stream/duckdb.db"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the integration is enabled, you can export collected metrics from the DuckDB database by using curl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># Get all metrics from the last 30 days in CSV format
curl -H "Accept: text/csv" http://localhost:8083/olap/export &gt; out.csv
# Get all metrics from the last 30 days in JSON format
curl -H "Accept: application/json" http://localhost:8083/olap/export &gt; out.json
# Get all metrics for all of February 2025 in CSV format
curl -H "Accept: text/csv" "http://localhost:8083/olap/export?fromDate=2025-02-01T00:00:00Z&amp;toDate=2025-03-01T00:00:00Z" &gt; out.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when using the <code>fromDate</code> and <code>toDate</code> parameters, the times must be specified in UTC in the ISO 8601 format (e.g. <code>2025-02-01T00:00:00Z</code>).
Otherwise the API will return a 400 Bad Request error.</p>
</div>
</div>
<div class="sect3">
<h4 id="_timescaledb_database_schema">2.4.2. TimescaleDB Database Schema</h4>
<div class="paragraph">
<p>Feel free to adapt the partition size to fit your needs. In this example we put 7 days but please follow the <a href="https://docs.timescale.com/use-timescale/latest/hypertables/about-hypertables/#best-practices-for-time-partitioning">TimescaleDB documentation</a> to choose the right partition size for your use case. We recommend a value between 7 days and 1 month. Note that the Helm and Kustomize templates already execute this script when the database is created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
CREATE TABLE "kafka_aggregated-table-friendly"
(
    "startTime"         TIMESTAMP        NOT NULL,
    "endTime"           TIMESTAMP        NOT NULL,
    "entityType"        VARCHAR          NOT NULL,
    "initialMetricName" VARCHAR          NOT NULL,
    "name"              VARCHAR          NOT NULL,
    "value"             DOUBLE PRECISION NOT NULL,
    "cost"              DOUBLE PRECISION NULL,
    "tags"              JSONB            NOT NULL,
    "context"           JSONB            NOT NULL,
    PRIMARY KEY ("startTime", "endTime", "entityType", "initialMetricName", "name")
);

SELECT create_hypertable('kafka_aggregated-table-friendly', by_range('startTime', INTERVAL '7 day'));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To prevent the database from being overwhelmed by the amount of data, we recommend creating a retention policy. In this example we will keep the data for 2 years:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT add_retention_policy('kafka_aggregated-table-friendly', INTERVAL '2 years');</code></pre>
</div>
</div>
<div class="paragraph">
<p>if you want to run the scripts above manually, you can use the interactive cli.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl exec -it -n &lt;namespace&gt; timescaledb-0 -- psql -U postgres -d postgres</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_kafka_connect">2.5. Kafka connect</h3>
<div class="paragraph">
<p>To write data from the kafka metric topic to the timeserie database we will use Kafka Connect.</p>
</div>
<div class="paragraph">
<p>Please refer to the kubenertes manifest to deploy a kafka connect cluster.</p>
</div>
<div class="sect3">
<h4 id="_configuration_of_the_connectors">2.5.1. Configuration of the connectors</h4>
<div class="paragraph">
<p>Don&#8217;t forget to adapt the hosts, users and password</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "name": "kafka-cost-control-aggregated",
  "config": {

    "tasks.max": "1",
    "topics": "aggregated-table-friendly",
    "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
    "connection.url": "jdbc:postgresql://timescaledb-service:5432/postgres?sslmode=disable",
    "connection.user": "postgres",
    "connection.password": "password",
    "insert.mode": "upsert",
    "auto.create": "false",
    "table.name.format": "kafka_${topic}",
    "pk.mode": "record_value",
    "pk.fields": "startTime,endTime,entityType,initialMetricName,name",
    "key.converter": "org.apache.kafka.connect.storage.StringConverter",
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schema.registry.url": "https://schema-registry-host",
    "value.converter.basic.auth.credentials.source": "USER_INFO",
    "value.converter.basic.auth.user.info": "schema-registry-user:schema-registry-password",
    "transforms": "flatten",
    "transforms.flatten.type": "org.apache.kafka.connect.transforms.Flatten$Value",
    "transforms.flatten.delimiter": "_"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure the connector, you can simply create a kubernetes tunnel to the running kafka connect service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n &lt;namespace&gt; port-forward service/kafka-connect-service 8083:8083</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in another terminal you can use the curl command to create the connector.
Don&#8217;t forget to edit the different users and passwords required (kafka, schema registry and database)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X POST -H "Content-Type: application/json" --data @kafka-connect-config.json http://localhost:8083/connectors</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the status of the connectors with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl -X GET http://localhost:8083/connectors/kafka-cost-control-aggregated/status | jq .</code></pre>
</div>
</div>
<div class="paragraph">
<p>The status should be running</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_grafana">2.6. Grafana</h3>
<div class="paragraph">
<p>Go to your grafana dashboard (you should have configured the host in the deployment). The default credentials are <code>admin:admin</code>. You will be asked to create a new password.</p>
</div>
<div class="sect3">
<h4 id="_database_connection">2.6.1. Database connection</h4>
<div class="paragraph">
<p>Go to the administration page and search for the plugin called <code>PostgreSQL</code>. It should normally be already installed, if not install it. You can then click on <code>add new data source</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Value</th>
<th class="tableblock halign-left valign-top">Info</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grafana-postgresql-datasource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>should be the default</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timescaledb-service:5432</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Kubernetes service for the database</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Database Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>this is the default if you didn&#8217;t change it</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>this is the default if you didn&#8217;t change it</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">postgres</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>this is the password you created in the <code>.env</code> file of the deployment</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TLS/SSL Mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">disabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>unless you configured it</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TimescaleDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">on</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>this will improve performance</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You  can keep the rest of the value as default.</p>
</div>
<div class="paragraph">
<p>TODO import dashboard</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">2.7. Troubleshooting</h3>
<div class="sect3">
<h4 id="_kafka_cost_control_is_never_ready">2.7.1. Kafka cost control is never ready</h4>
<div class="paragraph">
<p>If the kafka-cost-control pod is never ready there are good chances that it is waiting on a topic before it can start. If you look closely in the log you will see a message like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-log hljs" data-lang="log">2024-02-06 15:46:34,739 WARN  [io.qua.kaf.str.run.KafkaStreamsProducer] (pool-5-thread-1) Waiting for topic(s) to be created: [non-existing-topic]</code></pre>
</div>
</div>
<div class="paragraph">
<p>As soon as you create the missing topic(s), you should be good to go. Look again at the <a href="#section-topics">Topics</a> section for more information on how to create a topic.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">3. Architecture</h2>
<div class="sectionbody">
<div style="page-break-after: always;"></div>
<div class="sect2">
<h3 id="section-introduction-and-goals">3.1. Introduction and Goals</h3>
<div class="paragraph">
<p>Many organizations have introduced Kafka either on premise or in the cloud in recent years.<br>
Kafka platforms are often used as a shared service for multiple teams.
Having all costs centralized in a single cost center means that there is no incentive to save costs for individual users or projects.</p>
</div>
<div class="paragraph">
<p>Kafka Cost Control gives organizations transparency into the costs caused by applications and allow to distribute platform costs in a fair way to its users by providing a solution that</p>
</div>
<div class="ulist">
<ul>
<li>
<p>shows usage statistics per application and organizational unit</p>
</li>
<li>
<p>allows defining rules for platform cost distribution over organizational units or applications</p>
</li>
<li>
<p>works for most organizations, no matter if they use Confluent Cloud, Kubernetes or on-prem installations</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_requirements_overview">3.1.1. Requirements Overview</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Collection and aggregation of usage metrics and statistics from one or multiple Kafka clusters. Aggregation by time:</p>
<div class="ulist">
<ul>
<li>
<p>hourly (for debugging or as a metric to understand costs in near real-time)</p>
</li>
<li>
<p>daily</p>
</li>
<li>
<p>weekly</p>
</li>
<li>
<p>monthly</p>
</li>
</ul>
</div>
</li>
<li>
<p>Management of associations between client applications, projects and organizational units (OU)</p>
<div class="ulist">
<ul>
<li>
<p>automatic recognition of running consumer groups</p>
</li>
<li>
<p>automatic detection of principals/clients</p>
</li>
<li>
<p>creation, modification and deletion of contexts (projects and OUs)</p>
</li>
<li>
<p>interface to hook in custom logic for automatic assignment of clients to projects and OUs</p>
</li>
<li>
<p>manual assignment of auto-detected principals or consumer groups to projects and OUs</p>
</li>
<li>
<p>context can change in time, each item should have a start and end date (optional). This means that an item (ex a topic) can switch ownership at any point in time</p>
</li>
</ul>
</div>
</li>
<li>
<p>Visualization of usage statistics</p>
<div class="ulist">
<ul>
<li>
<p>Costs and usage statistics can be broken down interactively</p>
<div class="ulist">
<ul>
<li>
<p>Summary view: total costs for timespan (day, week, month) per OU</p>
</li>
<li>
<p>Detail View OU by category: costs by category (produce, consume, storage) for the selected OU in the selected timespan</p>
</li>
<li>
<p>Detail View OU by application/principal/consumer-group/topic</p>
</li>
</ul>
</div>
</li>
<li>
<p>Data must be made available in a format that can be used to display it with standard software (e.g. Kibana, Grafana, PowerBI), so that organizations can integrate it into an existing application landscape</p>
</li>
<li>
<p>provisioning of a lightweight default dashboard e.g. as a simple SPA, so that extra tooling is not mandatory to view the cost breakdown</p>
</li>
<li>
<p>Items not yet classified should be easily identifiable, so we know what configuration is missing (for example a topic has no OU yet)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Management of rules, that describe how costs are calculated (aka pricing rules)</p>
</li>
<li>
<p>Management of rules, that describe how costs are calculated, e.g.</p>
<div class="ulist">
<ul>
<li>
<p>fixed rates for available metrics, i.e. CHF 0.15 per consumed GB</p>
</li>
<li>
<p>base charge, i.e. CHF 0.5 per principal per hour</p>
</li>
<li>
<p>rules can be changed at any time, but take effect at a specified start time</p>
</li>
<li>
<p>optional: backtesting of rules using historical data</p>
</li>
</ul>
</div>
</li>
<li>
<p>Access Control</p>
<div class="ulist">
<ul>
<li>
<p>only authorized users can modify rules, OUs and projects</p>
</li>
<li>
<p>unauthenticated users should be able to see statistics</p>
</li>
</ul>
</div>
</li>
<li>
<p>Observability</p>
<div class="ulist">
<ul>
<li>
<p>expose metrics so that the cost control app can be monitored</p>
</li>
<li>
<p>proper logging</p>
</li>
</ul>
</div>
</li>
<li>
<p>Export of end-of-month reports as CSV or Excel for further manual processing</p>
</li>
<li>
<p>Ability to reprocess raw data in case a mistake was made. For example we see at the end of the month that an item was
wrongly attributed to an OU. We should be able to correct this and reprocess the data.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_quality_goals">3.1.2. Quality Goals</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Transferability / Extensibility</strong>: Kafka Cost Control should be modular, so that company-specific extensions can be added.<br>
 A core layer should contain common base functionality.
Company specific terms or features should be separated into dedicated modules.</p>
</li>
<li>
<p><strong>Maintainability</strong>: Reacting to changing requirements and implementing bug fixes should be possible within weeks.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/01_2_iso-25010-topics-EN.drawio.png" alt="Categories of Quality Requirements">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stakeholders">3.1.3. Stakeholders</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Role/Name</th>
<th class="tableblock halign-left valign-top">Expectations</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Kafka user</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should be able to see their usage. Should take ownership of resources.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Management</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should have an overview of the costs and usage of Kafka.</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="section-architecture-constraints">3.2. Architecture Constraints</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JVM based</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use common language at SPOUD and many clients to make sure many can contribute</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hosting On-Site (not SaaS only)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Companies may not want to expose usage data to a SaaS provider</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="section-system-scope-and-context">3.3. System Scope and Context</h3>
<div class="paragraph">
<p>Kafka Cost Control is a standalone application that needs to integrate into an existing IT landscape.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/context-diagram.svg" alt="context diagram" width="816" height="695">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="section-solution-strategy">3.4. Solution Strategy</h3>
<div class="sect3">
<h4 id="_used_technologies">3.4.1. Used Technologies</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Technology</th>
<th class="tableblock halign-left valign-top">Reason</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Telegraf</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Used for scraping metrics from data sources like Prometheus agents or Confluent Cloud API.</p>
</li>
<li>
<p>Versatile and lightweight tool that can be run in all environments.</p>
</li>
<li>
<p>supports Kafka</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for storing metrics, context info and pricing rules, reduces number of solution dependencies</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka Streams</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">for enriching metrics and storing pricing + context data into KTables</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DataStore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A datastore, e.g. a SQL DB, will be used for the time based aggregations (e.g. end of month reporting). Avoids complex calendar logic in Kafka Streams.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_time_based_aggregations_scraping_intervals">3.4.2. Time based aggregations &amp; scraping intervals</h4>
<div class="ulist">
<ul>
<li>
<p><strong>MetricsScraper</strong> should ingest metrics with an interval of 1 minute for confluent cloud metrics. Other data sources can have longer intervals.</p>
</li>
<li>
<p><strong>MetricsProcessor</strong> aggregates metrics with short time windows of 60 minutes</p>
<div class="ulist">
<ul>
<li>
<p>variable cost is usually defined as  <em>cost unit/minute</em></p>
</li>
<li>
<p>The window value is the accumulated cost for one hour (interpolation may be needed when data points are missing)</p>
</li>
<li>
<p>this allows some tolerance for gaps in metrics and varying ingestion intervals</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="section-building-block-view">3.5. Building Block View</h3>
<div class="sect3">
<h4 id="_whitebox_overall_system">3.5.1. Whitebox Overall System</h4>
<div class="imageblock">
<div class="content">
<img src="./images/whitebox.svg" alt="whitebox" width="942" height="250">
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Building block</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PricingRules</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores rules for turning usage information into costs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ContextProvider</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Manages contextual information that can be used to enrich metrics with company-specific information. E.g. relations between clientIds, applications, projects, cost centers, &#8230;&#8203;</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MetricProcessor</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Defines interfaces for metrics, that must be used by <em>MetricsScraper</em><br></p>
</li>
<li>
<p>Aggregates metrics into time buckets</p>
</li>
<li>
<p>Produces enriched data streams which includes contextual information</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MetricsScraper</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>uses a metric source, such as JMX or the confluent cloud metrics API to collect usage metrics</p>
</li>
<li>
<p>transforms the collected metrics into a format that is defined by <em>MetricProcessor</em></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_metricsscraper">3.5.2. MetricsScraper</h4>
<div class="sect4">
<h5 id="_confluent_cloud">Confluent Cloud</h5>
<div class="paragraph">
<p>Confluent exposes many metrics in prometheus format.
These will be scraped with telegraf.
Some information are missing from the prometheus export endpoint and need to be fetched with custom queries/requests.
This is done with a java application which exposes them as prometheus endpoint.
Docs: <a href="https://docs.confluent.io/cloud/current/monitoring/metrics-api.html" class="bare">https://docs.confluent.io/cloud/current/monitoring/metrics-api.html</a></p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Additional metric</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">endpoint/query</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partition count of a topic</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>AdminClient</code> to list all topics, partition count and replication factor</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">registered schemas for a topic</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>http requests to schema registry needed.
1. <code>GET {{schema_registry_url}}/schemas/</code>
2. Group by topic and create gauge metric for schema count by topic
WARNING:: Does not account for soft deleted topics in confluent cloud! Possible sanity check: sum of all schemas should equal total number of schemas reported by
<code><a href="https://api.telemetry.confluent.cloud/v2/metrics/cloud/descriptors/metrics?resource_type=schema_registry" class="bare">https://api.telemetry.confluent.cloud/v2/metrics/cloud/descriptors/metrics?resource_type=schema_registry</a></code>
If the sum is smaller, then soft deletes were made (using the max version number might yield a better result in this case).
WARNING:: If a non default naming strategy is used for subjects, then linking schemas/subjects to topics is not possible for all schemas.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="./images/.svg" alt="" width="592" height="360">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pricingrules">3.5.3. PricingRules</h4>
<div class="imageblock">
<div class="content">
<img src="./images/pricingrules.svg" alt="pricingrules" width="512" height="395">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_contextprovider">3.5.4. ContextProvider</h4>
<div class="imageblock">
<div class="content">
<img src="./images/contextprovider.svg" alt="contextprovider" width="370" height="331">
</div>
</div>
<div class="sect4">
<h5 id="_context_format">Context format</h5>
<div class="ulist">
<ul>
<li>
<p>metrics are defined in the core</p>
</li>
<li>
<p>a metric belongs to at least one of the dimensions</p>
<div class="ulist">
<ul>
<li>
<p>topic</p>
</li>
<li>
<p>consumer group</p>
</li>
<li>
<p>principal</p>
</li>
</ul>
</div>
</li>
<li>
<p>a context object can be attached to existing dimensions as a AVRO key-value pair to provide the needed flexibility</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">topic context as JSON record in a topic, record key="car-claims"</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "creationTime": "2024-01-01T00:00:00Z",
  "validFrom": "2024-01-01T00:00:00Z",
  "validUntil": null,
  "entityType": "TOPIC",
  "regex": "car-claims",
  "context": {
    "project": "claims-processing",
    "organization_unit": "non-life-insurance",
    "sap_psp_element": "1234.234.abc"
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">topic context rule as JSON record in a topic, record key="default-rule-since-2020"</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "creationTime": "2024-01-01T00:00:00Z",
  "validFrom": "2024-01-01T00:00:00Z",
  "validUntil": null,
  "entityType": "TOPIC",
  "regex": "^([a-z0-9-]+)\\.([a-z0-9-]+)\\.([a-z0-9-]+)-.*$",
  "context": {
    "tenant": "$1",
    "app_id": "$2",
    "component_id": "$3"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If naming conventions are very clear they could also be provided as a file / configuration.</p>
</div>
<div class="listingblock">
<div class="title">principal context as JSON record in a topic, record key="cluster-id-principal-default-ctxt"</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "creationTime": "2024-01-01T00:00:00Z",
  "validFrom": "2024-01-01T00:00:00Z",
  "validUntil": null,
  "entityType": "PRINCIPAL",
  "regex": "u-4j9my2",
  "context": {
    "project": "claims-processing",
    "organization_unit": "non-life-insurance",
    "sap_psp_element": "1234.234.abc"
  }
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">INFO</dt>
<dd>
<p>Context objects will be started as AVRO messages. We use JSON as a representation here for simplicity.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_context_lookup">Context Lookup</h5>
<div class="paragraph">
<p>State stores in Kafka Streams will be used to construct lookup tables for the context.</p>
</div>
<div class="paragraph">
<p>The key is a string and is a free value that can be set by the user. If no key is provided the API should create random unique key. The topic is compacted, meaning if we want to delete an item we can send a null payload with its key.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. context lookup table</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;type&gt;_&lt;cluster-id&gt;_&lt;principal_id&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;context-object&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PRINCIPAL_lx1dfsg_u-4j9my2_2024-01-01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">{&#8230;&#8203;, "regex": "u-4j9my2","context": {&#8230;&#8203;}}</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">b0bd9c9a-08e6-46c7-9f71-9eafe370da6c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;context-object&gt;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Once the table has been loaded, aggregated metrics can be enriched with a KTable - Streams join.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="section-runtime-view">3.6. Runtime View</h3>
<div class="sect3">
<h4 id="_metrics_ingestion_from_confluent_cloud">3.6.1. Metrics Ingestion from Confluent Cloud</h4>
<div class="paragraph">
<p>Process to gather and aggregate metrics from Confluent Cloud.</p>
</div>
<div class="paragraph">
<p>The Confluent Metrics Scraper calls the endpoint
<code>api.telemetry.confluent.cloud/v2/metrics/cloud/export?resource.kafka.id={CLUSTER-ID}</code>
with Basic Auth in an interval of 1 Minute to obtain all metrics in Prometheus format.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/runtime-scraping.svg" alt="runtime scraping" width="604" height="312">
</div>
</div>
<div class="paragraph">
<p>Telegraf is used to poll data using Confluent prometheus endpoint.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/runtime-confluent-telegraf.svg" alt="runtime confluent telegraf" width="656" height="67">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_metrics_using_kafka_admin_api">3.6.2. Metrics using Kafka Admin API</h4>
<div class="paragraph">
<p>Some information can be gathered from the Kafka Admin API. We will develop a simple application that connect to the Kafka Admin API and expose metrics as prometheus endpoint. We can then reuse Telegraf to publish those metrics to kafka.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/runtime-kafka-admin-api.svg" alt="runtime kafka admin api" width="910" height="59">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_sources_of_metrics">3.6.3. Other sources of metrics</h4>
<div class="paragraph">
<p>Anyone can publish to the raw metrics topic. The metrics should follow the telegraf format.
Recommendation: use one topic per source of metrics. The MetricEnricher application will anyway consume multiple raw metric topics.</p>
</div>
</div>
<div class="sect3">
<h4 id="_metrics_enrichment">3.6.4. Metrics Enrichment</h4>
<div class="imageblock">
<div class="content">
<img src="./images/runtime-enrich.svg" alt="runtime enrich" width="938" height="262">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Metrics are consumed from all the raw data topics.</p>
</li>
<li>
<p>Metrics are aggregated by the MetricsProcessor.
Here we:</p>
<div class="ulist">
<ul>
<li>
<p>aggregate by hours</p>
</li>
<li>
<p>attach context</p>
</li>
<li>
<p>attach pricing rule</p>
</li>
</ul>
</div>
</li>
<li>
<p>The aggregates are stored in the <code>aggregated-metrics</code> topic.</p>
</li>
<li>
<p>The aggregated metrics are stored into the query database.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The storage procedure into the query database must be idempotent in order to reprocess the enrichment in case of reprocessing.</p>
</div>
<div class="sect4">
<h5 id="_enrichment_for_topics">Enrichment for topics</h5>
<div class="listingblock">
<div class="title">metric with topic name from confluent cloud</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "fields": {
    "gauge": 40920
  },
  "name": "confluent_kafka_server_sent_bytes",
  "tags": {
    "env": "sdm",
    "host": "confluent.cloud",
    "kafka_id": "lkc-x5zqx",
    "topic": "mobiliar-agoora-state-global",
    "url": "https://api.telemetry.confluent.cloud/v2/metrics/cloud/export?resource.kafka.id=lkc-x5zqx"
  },
  "timestamp": 1704805140
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_enrichment_for_principals">Enrichment for principals</h5>
<div class="listingblock">
<div class="title">metric with principal id from confluent cloud</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "fields": {
    "gauge": 0
  },
  "name": "confluent_kafka_server_request_bytes",
  "tags": {
    "env": "sdm",
    "host": "confluent.cloud",
    "kafka_id": "lkc-x5zqx",
    "principal_id": "u-4j9my2",
    "type": "ApiVersions",
    "url": "https://api.telemetry.confluent.cloud/v2/metrics/cloud/export?resource.kafka.id=lkc-x5zqx"
  },
  "timestamp": 1704805200
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_metrics_grouping">3.6.5. Metrics Grouping</h4>
<div class="ulist">
<ul>
<li>
<p>confluent_kafka_server_request_bytes by kafka_id (Cluster) and principal_id (User) for the type Produce as sum stored in produced_bytes</p>
</li>
<li>
<p>confluent_kafka_server_response_bytes by kafka_id (Cluster) and principal_id (User) for the type Fetch as sum stored in fetched_bytes</p>
</li>
<li>
<p>confluent_kafka_server_retained_bytes by kafka_id (Cluster) and topic as min and max stored in retained_bytes_min and retained_bytes_max</p>
</li>
<li>
<p>confluent_kafka_server_consumer_lag_offsets by kafka_id (Cluster) and topic as list of consumer_group_id stored in consumergroups</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>maybe more are possible.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="section-deployment-view">3.7. Deployment View</h3>
<div class="imageblock">
<div class="content">
<img src="./images/deployment-view.svg" alt="deployment view" width="1940" height="281">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="section-technical-risks">3.8. Risks and Technical Debts</h3>
<div class="ulist">
<ul>
<li>
<p>Difficulty to get context data</p>
<div class="ulist">
<ul>
<li>
<p>Will the customer be willing to make the effort to provide the necessary data?</p>
</li>
</ul>
</div>
</li>
<li>
<p>Difficulty to put a set price on each kafka item</p>
</li>
<li>
<p>How to integrate general cost like operation, etc. (not linked to a particular kafka item)</p>
</li>
<li>
<p>Difficulty of integration with companies cost dashboard</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="section-glossary">3.9. Glossary</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Term</th>
<th class="tableblock halign-left valign-top">Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>OU</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Organization Unit</em></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-29 08:35:54 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/graphql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>